name: Download & Process Revisions

on:
  workflow_dispatch:
    inputs:
      product:
        description: "facebook / instagram / messenger / whatsapp"
        required: true
        default: "facebook"
      version:
        description: "Version number to download"
        required: true

jobs:
  process_revision:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip python3 python3-pip

      - name: Create revisions folder
        run: |
          mkdir -p revisions/${{ github.event.inputs.product }}/${{ github.event.inputs.version }}

      - name: Download archive
        run: |
          URL="https://wetransfer.com/download/local-bartender?id=eyJhcGlCYXNlIjoiL2FwaS92NCIsImRkUHJveHlCYXNlIjoiaHR0cHM6Ly9sb2NhbC1iYXJ0ZW5kZXItZGQtcHJveHkud2V0cmFuc2Zlci5uZXQvYXBpIiwidHJhbnNmZXJJZCI6ImFkZWQ0NzhmNjJhODExNDU5YmExMTAzOGUyODAyZTc5MjAyNTEyMTIwODExMjYiLCJzZWNyZXQiOiI1MTg2ZTUiLCJpbnRlbnQiOiJlbnRpcmVfdHJhbnNmZXIiLCJieXBhc3NSZWNvdmVyYWJpbGl0eUVudGl0bGVtZW50IjpmYWxzZSwiYWNjZXNzVG9rZW4iOiJleUpoYkdjaU9pSlNVekkxTmlJc0luUjVjQ0k2SWtwWFZDSXNJbXRwWkNJNklteERNMEpGVUZST016QmpUbmw1Y1V4SWNUVmZTVjl0Tmw4M1RsQmlaRWxzYkV4b1RsWTNPVVZQTmpBaWZRLmV5SjBiMnRsYmw5MGVYQmxJam9pWVdOalpYTnpYM1J2YTJWdUlpd2ljMk52Y0dVaU9pSnZjR1Z1YVdRZ1pXMWhhV3dnY0hKdlptbHNaU0J2Wm1ac2FXNWxYMkZqWTJWemN5SXNJbUYxWkNJNld5SmhkV1E2THk5MGNtRnVjMlpsY2kxaGNHa3RjSEp2WkM1M1pYUnlZVzV6Wm1WeUx5SmRMQ0psZUhBaU9qRTNOalUxTXpBM01qVXNJbWxoZENJNk1UYzJOVFV5TnpFeU5Td2lhWE56SWpvaWFIUjBjSE02THk5aGRYUm9MbmRsZEhKaGJuTm1aWEl1WTI5dEx5SXNJbXAwYVNJNklqSmpOMkkwT0dNME4yUTVZbVZpT1dObE9EQXlNR1kwTURaak9XSTBaalpqTmpKbFptUmpNamxtT0dReU1EUmxOR0k0TUdZd01UZ3dZVGd4TkRjMk1ESWlMQ0p6ZFdJaU9pSm5iMjluYkdVdGIyRjFkR2d5ZkRFeE1USTJORFF3T0RRMk5qWXdPRFUzTWpJME5TSjkudHJXZWs3U05IX1pfNE9ueE9mS29ObFg5SmVuQXpVVnAxWEdvcU1BclRvcGRpYXUtMXUyMmhHZVBuLXFuTUVUYWZ1U2dESWxIT1JjMW1uM3NQcXdzUkRMMXdoX0tuUmlzU2lMVURPM2xqWS1va19mNnhnNmtGeFVxRjlzY2Y1SnlENzBKV2NpLUlUYUZTOUk3UURSSHQ0VFFGVVE0ZmdGTjlESGNhU3IydUx2bUhHSXg2N3lBUkt3V09VOG5OVVV1dkgtTkItaFNDOVVQZ0V3OWdNOVAzTjZQU3kwSXYtQlJaUzlrM0M5dHRKSW9Vc21rQWdYeHU4UWFtMzJ4Q0VUSmF1RlA0cUZBbFVib0Y0ckhjRlBoSmxidktVQ1hZZTNjOTBQUDNNSWtvczYxeGxhaDNKQXJUYVVNbDBuWlZ3akFpWENLc2tjYlNhYUd6SUFsWHVIVFNnIiwibG9jYWxTdG9yYWdlSWQiOiJmOGY0MmQxYS0yY2FmLTQyOTQtYmM5ZC03MDU1ODEzOWZjMWIiLCJjdXJyZW50VGVhbUlkIjoiVDRuZm9ZOFZqRjJXQm9zOTJIbnAifQ=="
          echo "Downloading $URL ..."
          curl -L "$URL" -o archive.zip

      - name: Unzip archive directly into version folder
        run: |
          unzip archive.zip -d revisions/${{ github.event.inputs.product }}/${{ github.event.inputs.version }}

      - name: Generate JS extraction files
        working-directory: revisions/${{ github.event.inputs.product }}/${{ github.event.inputs.version }}
        run: |
          grep -Rh 'jsRouteBuilder")(' . > js-route-builder.js || true
          grep -Rh 'RelayOperation",\[' . > relay-operations.js || true
          grep -Rh 'XController").cr' . > x-controllers.js || true

      - name: Run hash.py
        run: |
          python3 hash.py revisions/${{ github.event.inputs.product }}/${{ github.event.inputs.version }}

      - name: Run diff.py between previous and current revision
        if: always()
        run: |
          if [ -f ".current-rev" ]; then
              OLD_VERSION=$(cat .current-rev)
              NEW_VERSION="${{ github.event.inputs.version }}"
              PRODUCT="${{ github.event.inputs.product }}"

              OLD_FOLDER="revisions/$PRODUCT/$OLD_VERSION"
              NEW_FOLDER="revisions/$PRODUCT/$NEW_VERSION"

              DIFF_DIR="diffs/$PRODUCT/${OLD_VERSION}-${NEW_VERSION}"
              mkdir -p "$DIFF_DIR"

              # Run diff.py in the target directory so output.js is created there
              pushd "$DIFF_DIR" > /dev/null
              python3 ../../../diff.py "$OLD_FOLDER" "$NEW_FOLDER"
              popd > /dev/null

              echo "Diff saved to $DIFF_DIR/output.js"
          else
              echo ".current-rev not found, skipping diff."
          fi

      - name: Save current version number
        run: |
          echo "${{ github.event.inputs.version }}" > .current-rev

      - name: Commit results
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Processed revision: product=${{ github.event.inputs.product }}, version=${{ github.event.inputs.version }}"
          branch: main
