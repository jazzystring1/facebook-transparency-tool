name: Download & Process Revisions

on:
  workflow_dispatch:
    inputs:
      product:
        description: "facebook / instagram / messenger / whatsapp"
        required: true
        default: "facebook"
      version:
        description: "Version number to download"
        required: true

jobs:
  process_revision:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip python3 python3-pip

      - name: Create revisions folder
        run: |
          mkdir -p "revisions/${{ github.event.inputs.product }}/${{ github.event.inputs.version }}"

      - name: Download archive
        run: |
          URL="https://www.facebook.com/btarchive/${{ github.event.inputs.version }}/${{ github.event.inputs.product }}"
          TMP_ZIP=$(mktemp /tmp/archive.XXXXXX.zip)
          echo "Downloading $URL ..."
          curl -L "$URL" -o "$TMP_ZIP"
          echo "TMP_ZIP=$TMP_ZIP" >> $GITHUB_ENV

      - name: Unzip archive directly into version folder
        run: |
          REV_DIR="revisions/${{ github.event.inputs.product }}/${{ github.event.inputs.version }}"
          mkdir -p "$REV_DIR"
          unzip -q "$TMP_ZIP" -d "$REV_DIR"
          rm -f "$TMP_ZIP"  # clean up temp zip

      - name: Generate JS extraction files
        working-directory: revisions/${{ github.event.inputs.product }}/${{ github.event.inputs.version }}
        run: |
          grep -Rh 'jsRouteBuilder")(' . > js-route-builder.js || true
          grep -Rh 'RelayOperation",\[' . > relay-operations.js || true
          grep -Rh 'XController").cr' . > x-controllers.js || true

      - name: Run hash.py
        run: |
          python3 hash.py revisions/${{ github.event.inputs.product }}/${{ github.event.inputs.version }}
      
      - name: Clean up extracted files
        working-directory: revisions/${{ github.event.inputs.product }}/${{ github.event.inputs.version }}
        run: |
          # Keep only the generated JS files and hashes.json
          find . -type f ! -name "js-route-builder.js" ! -name "relay-operations.js" ! -name "x-controllers.js" ! -name "hashes.json" -delete

      - name: Run diff between previous and current revision
        if: always()
        run: |
          if [ -f ".current-rev" ]; then
              ROOT="$GITHUB_WORKSPACE"
              OLD_VERSION=$(cat .current-rev)
              NEW_VERSION="${{ github.event.inputs.version }}"
              PRODUCT="${{ github.event.inputs.product }}"

              OLD_FOLDER="$ROOT/revisions/$PRODUCT/$OLD_VERSION"
              NEW_FOLDER="$ROOT/revisions/$PRODUCT/$NEW_VERSION"

              DIFF_DIR="$ROOT/diffs/$PRODUCT/${OLD_VERSION}-${NEW_VERSION}"
              mkdir -p "$DIFF_DIR"
              touch $DIFF_DIR/.gitkeep

              pushd "$DIFF_DIR" > /dev/null
              python3 "$ROOT/diff.py" "$OLD_FOLDER" "$NEW_FOLDER"
              popd > /dev/null

              echo "Diff saved to $DIFF_DIR/output.js"
          else
              echo ".current-rev not found, skipping diff."
          fi

      - name: Save current version number
        run: |
          echo "${{ github.event.inputs.version }}" > .current-rev

      - name: Commit results
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Processed revision: product=${{ github.event.inputs.product }}, version=${{ github.event.inputs.version }}"
          branch: main
